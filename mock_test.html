<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mock Test | Round Based</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --dark-bg: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 1rem;
            position: relative;
            overflow-x: hidden;
            color: white;
        }

        .bg-particles {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            border-radius: 50%;
            animation: particleFloat 25s infinite linear;
        }

        .particle:nth-child(1) { width: 80px; height: 80px; top: 20%; left: 10%; }
        .particle:nth-child(2) { width: 50px; height: 50px; top: 70%; right: 15%; }
        .particle:nth-child(3) { width: 60px; height: 60px; bottom: 30%; left: 20%; }

        @keyframes particleFloat {
            0% { transform: translateY(0px) scale(1); opacity: 0.6; }
            50% { transform: translateY(-25px) rotate(120deg) scale(1.1); opacity: 1; }
            100% { transform: translateY(0px) rotate(360deg) scale(1); opacity: 0.6; }
        }

        .test-card {
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
            padding: 2.5rem;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 35px 70px rgba(0, 0, 0, 0.4);
        }

        .round-tracker {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .round-step { text-align: center; flex: 1; opacity: 0.4; transition: 0.3s; }
        .round-step.active { opacity: 1; }
        .round-step.completed { opacity: 1; color: #10b981; }

        .round-icon {
            width: 45px; height: 45px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 0.5rem;
            border: 2px solid var(--glass-border);
        }

        .round-step.active .round-icon {
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
        }

        .round-step.completed .round-icon { background: #10b981; border-color: #10b981; }

        .info-bar {
            display: flex; justify-content: space-between;
            background: rgba(0,0,0,0.2);
            padding: 1rem 1.5rem; border-radius: 15px;
            margin-bottom: 2rem; border: 1px solid var(--glass-border);
        }

        .timer { color: #fbbf24; font-weight: 700; }

        .question-box { min-height: 250px; }
        .q-text { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; }

        .option-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 1rem; border-radius: 15px;
            margin-bottom: 0.8rem; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; gap: 15px;
        }

        .option-card:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(5px); }
        .option-card.selected {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-color: transparent;
        }

        .btn-nav {
            background: var(--primary); color: white; border: none;
            padding: 10px 25px; border-radius: 12px; font-weight: 700; transition: 0.3s;
        }

        .btn-prev {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid var(--glass-border);
            padding: 10px 25px;
            border-radius: 12px;
            font-weight: 700;
            transition: 0.3s;
        }
        .btn-prev:hover { background: rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body>
    <div class="bg-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="test-card">
        <div class="round-tracker">
            <div class="round-step active" id="step1">
                <div class="round-icon"><i class="fas fa-calculator"></i></div>
                <small>Aptitude</small>
            </div>
            <div class="round-step" id="step2">
                <div class="round-icon"><i class="fas fa-language"></i></div>
                <small>Verbal</small>
            </div>
            <div class="round-step" id="step3">
                <div class="round-icon"><i class="fas fa-microchip"></i></div>
                <small>Domain</small>
            </div>
        </div>

        <div class="info-bar">
            <span>Round: <b id="currentRoundName">Aptitude</b></span>
            <span class="timer"><i class="fas fa-clock"></i> <span id="timerText">20:00</span></span>
            <span>Question: <b id="qCounter">1/10</b></span>
        </div>

        <div class="question-box">
            <div class="q-text" id="questionText">Loading questions...</div>
            <div id="optionsContainer"></div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <button class="btn-prev" id="prevBtn" onclick="handlePrevious()" style="visibility: hidden;">
                <i class="fas fa-chevron-left me-2"></i> Previous
            </button>
            <button class="btn-nav" id="nextBtn" onclick="handleNext()">
                Save & Next <i class="fas fa-chevron-right ms-2"></i>
            </button>
        </div>
    </div>

    <script>
        let currentRound = 1;
        let questionIndex = 0; 
        let timeLeft = 1200; 
        let scores = { aptitude: 0, verbal: 0, domain: 0 };
        let allQuestions = {};
        let roundQuestions = [];
        let userAnswers = []; // Persistent storage for the current round choices

        async function init() {
            try {
                const response = await fetch('/get_test_questions');
                allQuestions = await response.json();
                loadRound();
                startTimer();
            } catch (e) {
                document.getElementById('questionText').innerText = "Error loading questions. Check server.";
            }
        }

        function startTimer() {
            const timerInterval = setInterval(() => {
                let mins = Math.floor(timeLeft / 60);
                let secs = timeLeft % 60;
                document.getElementById('timerText').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleRoundEnd();
                }
                timeLeft--;
            }, 1000);
        }

        function loadRound() {
            questionIndex = 0;
            userAnswers = new Array(10).fill(null); 
            const roundKeys = ['aptitude', 'verbal', 'domain'];
            const key = roundKeys[currentRound - 1];
            
            let apiKey = key;
            if (key === 'domain') {
                const userDomain = "{{ domain }}".toLowerCase();
                apiKey = `${userDomain}_domain`;
            }

            roundQuestions = allQuestions[apiKey] || [];
            renderQuestion();
            updateTracker();
        }

        function renderQuestion() {
            if (questionIndex >= roundQuestions.length) return;
            
            const q = roundQuestions[questionIndex];
            document.getElementById('questionText').innerText = q.question;
            document.getElementById('qCounter').innerText = `${questionIndex + 1}/${roundQuestions.length}`;
            
            // Visibility of Previous Button
            document.getElementById('prevBtn').style.visibility = questionIndex > 0 ? 'visible' : 'hidden';

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';

            q.options.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'option-card';
                
                // Highlight if already answered
                if (userAnswers[questionIndex] === opt) {
                    div.classList.add('selected');
                }

                div.innerHTML = `<span>${String.fromCharCode(65 + i)}</span><span class="opt-text">${opt}</span>`;
                div.onclick = () => {
                    document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                    div.classList.add('selected');
                    userAnswers[questionIndex] = opt; // Save the choice
                };
                container.appendChild(div);
            });
        }

        function handleNext() {
            if (!userAnswers[questionIndex]) {
                alert("Please select an option before moving forward!");
                return;
            }

            if (questionIndex < roundQuestions.length - 1) {
                questionIndex++;
                renderQuestion();
            } else {
                handleRoundEnd();
            }
        }

        function handlePrevious() {
            if (questionIndex > 0) {
                questionIndex--;
                renderQuestion();
            }
        }

        function handleRoundEnd() {
            // Calculate score for the round
            let correctCount = 0;
            userAnswers.forEach((ans, idx) => {
                if (ans === roundQuestions[idx].answer) {
                    correctCount++;
                }
            });

            const scorePercent = (correctCount / roundQuestions.length) * 100;
            const keys = ['aptitude', 'verbal', 'domain'];
            scores[keys[currentRound - 1]] = scorePercent;

            if (currentRound < 3) {
                currentRound++;
                timeLeft = 1200; // Reset timer for next round
                alert(`Round ${currentRound-1} Completed! Proceeding to the next round.`);
                loadRound();
            } else {
                submitTestResults();
            }
        }

        function updateTracker() {
            const roundNames = ["Aptitude", "Verbal", "Domain"];
            document.getElementById('currentRoundName').innerText = roundNames[currentRound - 1];
            
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById(`step${i}`);
                el.classList.remove('active', 'completed');
                if (i < currentRound) el.classList.add('completed');
                if (i === currentRound) el.classList.add('active');
            }
        }

        async function submitTestResults() {
            document.body.innerHTML = "<div class='text-center w-100' style='margin-top:20%'><h1>Finalizing Scores...</h1></div>";
            const response = await fetch('/submit_test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(scores)
            });
            const result = await response.json();
            if (result.status === 'success') {
                window.location.href = result.redirect;
            }
        }

        window.onload = init;
    </script>
</body>
</html>